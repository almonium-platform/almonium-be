name: Deploy BE to Staging

on:
  push:
    branches: [ develop ]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Specify the image tag (git SHA) to deploy. Leave blank to build from the latest `develop` branch commit.'
        required: false
        type: string

permissions:
  contents: read
  packages: write

jobs:
  # JOB 1: The Brain. It decides the tag and if a build is needed.
  resolve-image:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.get_tag.outputs.tag }}
      build_needed: ${{ steps.get_tag.outputs.build_needed }}
    steps:
      - id: get_tag
        run: |
          if [[ -n "${{ inputs.image_tag }}" ]]; then
            echo "Manual Run: Re-deploying specified tag."
            echo "tag=${{ inputs.image_tag }}" >> $GITHUB_OUTPUT
            echo "build_needed=false" >> $GITHUB_OUTPUT
          else
            echo "Push or Manual Run w/o tag: Building latest commit."
            echo "tag=${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "build_needed=true" >> $GITHUB_OUTPUT
          fi

  # JOB 2: The Builder. It only runs when the brain tells it to.
  build:
    needs: resolve-image
    if: needs.resolve-image.outputs.build_needed == 'true'
    uses: ./.github/workflows/build.yaml
    with:
      image_tag: ${{ needs.resolve-image.outputs.tag }}
    secrets: inherit

  # JOB 3: The Deployer. It always runs and gets its tag from the brain.
  deploy:
    needs: [ resolve-image, build ]
    if: always()
    runs-on: ubuntu-latest
    environment: staging
    permissions:
      packages: read
    steps:
      - name: Checkout almonium-infra repository
        uses: actions/checkout@v4
        with:
          repository: almonium-platform/almonium-infra
          path: almonium-infra
          ssh-key: ${{ secrets.INFRA_REPO_CHECKOUT_KEY }}

      - name: Set up SSH Agent for Ansible to connect to VM
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.CLOUD_KEY }}

      - name: Install Ansible and Docker collection
        run: |
          python -m venv ansible_venv
          source ansible_venv/bin/activate
          echo "Installing Ansible core..."
          pip install ansible
          echo "Ansible core version:"
          ansible --version
          echo "Installing community.docker collection..."
          ansible-galaxy collection install community.docker
          echo "Verifying docker modules are available (optional check)..."
          ansible-doc -t module -l | grep docker_compose

      - name: Run Ansible Playbook for Prod Deployment
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"

          GHA_DEPLOY_ENV: "${{ vars.ENVIRONMENT_NAME }}"
          GHA_IMAGE_TAG: "${{ needs.resolve-image.outputs.tag }}"
          GHA_ACTOR: "${{ github.actor }}"
          GHA_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

          GHA_API_HOSTNAME: "${{ vars.API_HOSTNAME }}"
          GHA_LOCAL_PORT: "${{ vars.LOCAL_PORT }}"
          GHA_DEBUG_PORT: "${{ vars.DEBUG_PORT }}"
          GHA_SPRING_PROFILE: "${{ vars.SPRING_PROFILE }}"
          GHA_JWT_SECRET: "${{ secrets.JWT_SECRET }}"
          GHA_DB_NAME: "${{ vars.DB_NAME }}"
          GHA_DB_HOST: "${{ secrets.DB_HOST }}"
          GHA_DB_PORT: "${{ vars.DB_PORT }}"
          GHA_DB_SCHEMA: "${{ vars.DB_SCHEMA }}"
          GHA_DB_USERNAME: "${{ secrets.DB_USERNAME }}"
          GHA_DB_PASSWORD: "${{ secrets.DB_PASSWORD }}"
          GHA_RAPID_API_KEY: "${{ secrets.RAPID_API_KEY }}"
          GHA_WORDNIK_KEY: "${{ secrets.WORDNIK_KEY }}"
          GHA_YANDEX_KEY: "${{ secrets.YANDEX_KEY }}"
          GHA_OPENAI_KEY: "${{ secrets.OPENAI_KEY }}"
          GHA_GEMINI_API_KEY: "${{ secrets.GEMINI_API_KEY }}"
          GHA_STRIPE_KEY: "${{ secrets.STRIPE_KEY }}"
          GHA_STRIPE_WEBHOOK_SECRET: "${{ secrets.STRIPE_WEBHOOK_SECRET }}"
          GHA_STREAM_KEY: "${{ secrets.STREAM_KEY }}"
          GHA_STREAM_SECRET: "${{ secrets.STREAM_SECRET }}"
          GHA_GOOGLE_PROJECT_ID: "${{ vars.GOOGLE_PROJECT_ID }}"
          GHA_GOOGLE_SERVICE_ACCOUNT_KEY_BASE64: "${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY_BASE64 }}"
          GHA_FIREBASE_STORAGE_BUCKET: "${{ vars.FIREBASE_STORAGE_BUCKET }}"
          GHA_GOOGLE_ID: "${{ vars.GOOGLE_ID }}"
          GHA_GOOGLE_SECRET: "${{ secrets.GOOGLE_SECRET }}"
          GHA_FACEBOOK_ID: "${{ vars.FACEBOOK_ID }}"
          GHA_FACEBOOK_SECRET: "${{ secrets.FACEBOOK_SECRET }}"
          GHA_APPLE_ID: "${{ vars.APPLE_ID }}"
          GHA_APPLE_SECRET: "${{ secrets.APPLE_SECRET }}"
          GHA_RABBITMQ_HOST: "${{ vars.RABBITMQ_HOST }}"
          GHA_RABBITMQ_USER: "${{ secrets.RABBITMQ_USER }}"
          GHA_RABBITMQ_PASS: "${{ secrets.RABBITMQ_PASS }}"
          GHA_RABBITMQ_PORT: "${{ vars.RABBITMQ_PORT }}"
          GHA_MAIL_USERNAME: "${{ secrets.MAIL_USERNAME }}"
          GHA_MAIL_PASSWORD: "${{ secrets.MAIL_PASSWORD }}"

        run: |
          source ansible_venv/bin/activate
          cd almonium-infra/ansible
          
          TARGET_GROUP="${GHA_DEPLOY_ENV}_servers"

          ansible-playbook playbook-deploy-almonium-be.yaml \
            -i inventory/hosts.ini \
            --limit "${TARGET_GROUP}" \
            --extra-vars "DEPLOY_IMAGE_TAG=${GHA_IMAGE_TAG}" \
            --extra-vars "DEPLOY_GH_ACTOR=${GHA_ACTOR}" \
            --extra-vars "DEPLOY_GH_TOKEN=${GHA_TOKEN}"
